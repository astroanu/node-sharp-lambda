{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/handlers/resizer/index.js","webpack:///./src/handlers/resizer/resizeHandler.js","webpack:///./src/handlers/resizer/s3Handler.js","webpack:///external \"aws-sdk\"","webpack:///external \"sharp\"","webpack:///external \"stream\""],"names":["handler","event","imagePath","resizeHandler","_process","URL","process","env","BUCKET","REGION","headers","statusCode","body","error","console","log","Error","sharp","require","ResizerHandler","constructor","size","image","pathParameters","resize","path","sizeArray","split","width","parseInt","height","Key","newKey","Bucket","streamResize","toFormat","readStream","s3Handler","writeStream","uploaded","pipe","AWS","region","S3","S3Handler","getObject","createReadStream","passThrough","stream","PassThrough","upload","ContentType","Body","promise"],"mappings":"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","file":"src/handlers/resizer/index.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/handlers/resizer/index.js\");\n","import { resizeHandler } from './resizeHandler'\n\nexport const handler = async (event) => {\n  try {\n    const imagePath = await resizeHandler._process(event)\n    const URL = `http://${process.env.BUCKET}.s3-website.${process.env.REGION}.amazonaws.com`\n\n    return {\n      headers: { 'location': `${URL}/${imagePath}` },\n      statusCode: 301,\n      body: ''\n    }\n  } catch (error) {\n    console.log(error)\n    return new Error(error)\n  }\n}\n","import { s3Handler } from './s3Handler'\n\n//Core image processing package\nconst sharp = require('sharp')\n\nclass ResizerHandler {\n  constructor(){ }\n\n  async _process(event) {\n    const { size, image } = event.pathParameters\n    return await this.resize(size, image)\n  }\n\n  async resize(size, path) {\n    try {\n      const sizeArray = size.split('x')\n      const width = parseInt(sizeArray[0])\n      const height = parseInt(sizeArray[1])\n      const Key = path\n      const newKey = '' + width + 'x' + height + '/' + path\n\n      const Bucket = process.env.BUCKET\n      const streamResize = sharp()\n        .resize(width, height)\n        .toFormat('png')\n\n      const readStream = s3Handler.readStream({ Bucket, Key })\n      const { writeStream, uploaded } = s3Handler.writeStream({ Bucket, Key: newKey })\n\n      //data streaming\n      readStream\n        .pipe(streamResize)\n        .pipe(writeStream)\n\n      await uploaded\n      return newKey\n    } catch (error) {\n      throw new Error(error)\n    }\n  }\n}\n\nexport const resizeHandler = new ResizerHandler()\n","import * as AWS from 'aws-sdk'\nimport stream from 'stream'\n\nAWS.config.region = 'us-east-1'\nconst S3 = new AWS.S3()\n\nclass S3Handler {\n  constructor() { }\n\n  readStream({ Bucket, Key }) {\n    return S3.getObject({ Bucket, Key }).createReadStream()\n  }\n\n  writeStream({ Bucket, Key }) {\n    const passThrough = new stream.PassThrough()\n    return {\n      writeStream: passThrough,\n      uploaded: S3.upload({\n        ContentType: 'image/png',\n        Body: passThrough,\n        Bucket,\n        Key\n      }).promise()\n    }\n  }\n}\n\nexport const s3Handler = new S3Handler()\n","module.exports = require(\"aws-sdk\");","module.exports = require(\"sharp\");","module.exports = require(\"stream\");"],"sourceRoot":""}